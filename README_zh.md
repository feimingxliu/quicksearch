### QuickSearch

#### 相关性分数

词 `t` 在文档 `d` 的词频（ `tf` ）是该词在文档中出现次数的平方根。

```
tf(t in d) = √frequency 
```

词在集合所有文档里出现的频率是多少？频次越高，权重 *越低* 。常用词如 `and` 或 `the` 对相关度贡献很少，因为它们在多数文档中都会出现，一些不常见词如 `elastic` 或 `hippopotamus`
可以帮助我们快速缩小范围找到感兴趣的文档。逆向文档频率的计算公式如下：

词 `t` 的逆向文档频率（ `idf` ）是：索引中文档数量除以所有包含该词的文档数，然后求其对数。

```
idf(t) = 1 + log ( numDocs / (docFreq + 1)) 
```

字段的长度是多少？字段越短，字段的权重 *越高* 。如果词出现在类似标题 `title` 这样的字段，要比它出现在内容 `body` 这样的字段中的相关度更高。字段长度的归一值公式如下：

字段长度归一值（ `norm` ）是字段中词数平方根的倒数。

```
norm(d) = 1 / √numTerms 
```

`score(q,d)` 是文档 `d` 与查询 `q` 的相关度评分。

`queryNorm(q)` 是*查询归一化*因子。

`coord(q,d)` 是 *协调* 因子。

查询 `q` 中每个词 `t` 对于文档 `d` 的权重和。

`tf(t in d)` 是词 `t` 在文档 `d` 中的词频。

`idf(t)` 是词 `t` 的逆向文档频率。

`t.getBoost()` 是查询中使用的 *boost*。

`norm(t,d)` 是 字段长度归一值 （如果存在）的和。

```
score(q,d)  =  
            queryNorm(q)  
          · coord(q,d)    
          · ∑ (           
                tf(t in d)   
              · idf(t)²      
              · t.getBoost() 
              · norm(t,d)    
            ) (t in q)    
```

`sumOfSquaredWeights` 是查询里每个词的 IDF 的平方和。

```
queryNorm = 1 / √sumOfSquaredWeights 
```

*协调因子* （ `coord` ）可以为那些查询词包含度高的文档提供奖励，文档里出现的查询词越多，它越有机会成为好的匹配结果。

设想查询 `quick brown fox` ，每个词的权重都是 1.5 。如果没有协调因子，最终评分会是文档里所有词权重的总和。例如：

- 文档里有 `fox` → 评分： 1.5
- 文档里有 `quick fox` → 评分： 3.0
- 文档里有 `quick brown fox` → 评分： 4.5

协调因子将评分与文档里匹配词的数量相乘，然后除以查询里所有词的数量，如果使用协调因子，评分会变成：

- 文档里有 `fox` → 评分： `1.5 * 1 / 3` = 0.5
- 文档里有 `quick fox` → 评分： `3.0 * 2 / 3` = 2.0
- 文档里有 `quick brown fox` → 评分： `4.5 * 3 / 3` = 4.5

协调因子能使包含所有三个词的文档比只包含两个词的文档评分要高出很多。